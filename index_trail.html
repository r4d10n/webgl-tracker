<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Demo for HW Design Labs</title>
		<style>
			body { margin: 0; }
		</style>
	</head>
	<body>

        <script async src="https://unpkg.com/es-module-shims@1.3.6/dist/es-module-shims.js"></script>
        <script type="importmap">
        {
            "imports": {
            "three": "https://unpkg.com/three@0.145.0/build/three.module.js"
            }
        }
        </script>

		<script type="module">
            import * as THREE from 'three';
            import { OrbitControls } from 'https://unpkg.com/three@0.145.0/examples/jsm/controls/OrbitControls.js';

            var sphere_array_red = [];
            var sphere_array_green = [];
            var sphere_array_blue = [];
            var num_spheres_red_history = 100;
            var num_spheres_green_history = 100;
            var num_spheres_blue_history = 100;

            var create_line_boundary = function()
            {
                const line_boundary_color = 0x0000ff;
                const line_boundary_material = new THREE.LineBasicMaterial( { color: line_boundary_color } );
                const line_points = [];
                line_points.push( new THREE.Vector3( 0, 0, 0 ) );
                line_points.push( new THREE.Vector3( 0, 100, 0 ) );
                line_points.push( new THREE.Vector3( 100, 100, 0 ) );
                line_points.push( new THREE.Vector3( 100, 0, 0 ) );
                line_points.push( new THREE.Vector3( 0, 0, 0 ) );

                line_points.push( new THREE.Vector3( 0, 0, -100 ) );
                line_points.push( new THREE.Vector3( 0, 100, -100 ) );
                line_points.push( new THREE.Vector3( 100, 100, -100 ) );
                line_points.push( new THREE.Vector3( 100, 0, -100 ) );
                line_points.push( new THREE.Vector3( 0, 0, -100 ) );

                line_points.push( new THREE.Vector3( 0, 100, -100 ) );
                line_points.push( new THREE.Vector3( 0, 100, 0 ) );
                line_points.push( new THREE.Vector3( 0, 100, -100 ) );

                line_points.push( new THREE.Vector3( 100, 100, -100 ) );
                line_points.push( new THREE.Vector3( 100, 100, 0 ) );
                line_points.push( new THREE.Vector3( 100, 100, -100 ) );

                line_points.push( new THREE.Vector3( 100, 0, -100 ) );
                line_points.push( new THREE.Vector3( 100, 0, 0 ) );
                line_points.push( new THREE.Vector3( 100, 0, -100 ) );

                line_points.push( new THREE.Vector3( 0, 0, -100 ) );
                line_points.push( new THREE.Vector3( 0, 0, 0 ) );

                const line_boundary_geometry = new THREE.BufferGeometry().setFromPoints( line_points );
                const line_boundary = new THREE.Line( line_boundary_geometry, line_boundary_material );

                return line_boundary;
            };

            var create_sphere = function(x, y, z, radius, fill_color)
            {
                const sphere_geometry = new THREE.SphereGeometry( radius, 32, 16 );
                const sphere_material = new THREE.MeshBasicMaterial( { color: fill_color } );
                const sphere = new THREE.Mesh( sphere_geometry, sphere_material );
                sphere.position.x = x;
                sphere.position.y = y;
                sphere.position.z = z;
                return sphere;
            }

            var set_sphere_position = function(sphere, x, y, z)
            {
                sphere.position.x = x;
                sphere.position.y = y;
                sphere.position.z = z;
            }

            var change_sphere_position = function(scene, sphere_array, num_spheres, x, y, z, radius, fill_color)
            {
                /* Remove all the existing objects */
                for (let i = 0; i < sphere_array.length; i++)
                {
                    scene.remove(sphere_array[i]);
                }
                
                var new_sphere = create_sphere(x, y, z, radius, fill_color);

                sphere_array.push(new_sphere);
                
                var num_excess_spheres = sphere_array.length - num_spheres;
                if (num_excess_spheres > 0)
                    for (let i = 0; i < num_excess_spheres; i++)
                        sphere_array.shift();
                
                for (let i = 0; i < sphere_array.length; i++)
                {
                    sphere_array[i].scale.multiplyScalar(0.98);
                    sphere_array[i].scale.clampScalar(0.01, 2.0);
                    scene.add(sphere_array[i]);
                }
            }

            const renderer = new THREE.WebGLRenderer();
            renderer.setSize( window.innerWidth, window.innerHeight );
            document.body.appendChild( renderer.domElement );

            const camera = new THREE.PerspectiveCamera( 100, window.innerWidth / window.innerHeight, 1, 500 );

            const controls = new OrbitControls( camera, renderer.domElement );
            camera.position.set( 50, 50, 100 );
            camera.lookAt( 50, 50, 50 );
            controls.update();

            const scene = new THREE.Scene();

            var line_boundary = create_line_boundary();

            scene.add( line_boundary );
            renderer.render( scene, camera );

            const socket = new WebSocket('ws://localhost:8000');
            var websockConnected = false;
            function animate() 
            {
	            requestAnimationFrame( animate );
                controls.update();
                if (websockConnected == true) 
                    socket.send("Hello");
                //set_sphere_position(sphere_red, sphere_red.position.x + 1, sphere_red.position.y, sphere_red.position.z);
	            renderer.render( scene, camera );
            }

            socket.addEventListener('open', function (event) {
                websockConnected = true;
            });

            socket.addEventListener('message', function (event) {
                var rs = JSON.parse(event.data)
                var sphere_data = JSON.parse(rs['received_string']);
                console.log(sphere_data);
                if (sphere_data.id == "red")
                {
                    change_sphere_position(scene, sphere_array_red, num_spheres_red_history, sphere_data.x, sphere_data.y, -1 * sphere_data.z, 2, 0xff0000);
                }
                if (sphere_data.id == "green")
                {
                    change_sphere_position(scene, sphere_array_green, num_spheres_green_history, sphere_data.x, sphere_data.y, -1 * sphere_data.z, 2, 0x00ff00);
                }
                if (sphere_data.id == "blue")
                {
                    change_sphere_position(scene, sphere_array_blue, num_spheres_blue_history, sphere_data.x, sphere_data.y, -1 * sphere_data.z, 2, 0x0000ff);
                }
            });
        animate();            
        </script>
	</body>
</html>