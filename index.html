<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Demo for HW Design Labs</title>
		<style>
			body { margin: 0; }
		</style>
	</head>
	<body>

        <script async src="https://unpkg.com/es-module-shims@1.3.6/dist/es-module-shims.js"></script>
        <script type="importmap">
        {
            "imports": {
            "three": "https://unpkg.com/three@0.145.0/build/three.module.js"
            }
        }
        </script>

		<script type="module">
            import * as THREE from 'three';
            import { OrbitControls } from 'https://unpkg.com/three@0.145.0/examples/jsm/controls/OrbitControls.js';

            var create_line_boundary = function()
            {
                const line_boundary_color = 0x0000ff;
                const line_boundary_material = new THREE.LineBasicMaterial( { color: line_boundary_color } );
                const line_points = [];
                line_points.push( new THREE.Vector3( 0, 0, 0 ) );
                line_points.push( new THREE.Vector3( 0, 100, 0 ) );
                line_points.push( new THREE.Vector3( 100, 100, 0 ) );
                line_points.push( new THREE.Vector3( 100, 0, 0 ) );
                line_points.push( new THREE.Vector3( 0, 0, 0 ) );

                line_points.push( new THREE.Vector3( 0, 0, -100 ) );
                line_points.push( new THREE.Vector3( 0, 100, -100 ) );
                line_points.push( new THREE.Vector3( 100, 100, -100 ) );
                line_points.push( new THREE.Vector3( 100, 0, -100 ) );
                line_points.push( new THREE.Vector3( 0, 0, -100 ) );

                line_points.push( new THREE.Vector3( 0, 100, -100 ) );
                line_points.push( new THREE.Vector3( 0, 100, 0 ) );
                line_points.push( new THREE.Vector3( 0, 100, -100 ) );

                line_points.push( new THREE.Vector3( 100, 100, -100 ) );
                line_points.push( new THREE.Vector3( 100, 100, 0 ) );
                line_points.push( new THREE.Vector3( 100, 100, -100 ) );

                line_points.push( new THREE.Vector3( 100, 0, -100 ) );
                line_points.push( new THREE.Vector3( 100, 0, 0 ) );
                line_points.push( new THREE.Vector3( 100, 0, -100 ) );

                line_points.push( new THREE.Vector3( 0, 0, -100 ) );
                line_points.push( new THREE.Vector3( 0, 0, 0 ) );

                const line_boundary_geometry = new THREE.BufferGeometry().setFromPoints( line_points );
                const line_boundary = new THREE.Line( line_boundary_geometry, line_boundary_material );

                return line_boundary;
            };

            var create_sphere = function(x, y, z, radius, fill_color)
            {
                const sphere_geometry = new THREE.SphereGeometry( radius, 32, 16 );
                const sphere_material = new THREE.MeshBasicMaterial( { color: fill_color } );
                const sphere = new THREE.Mesh( sphere_geometry, sphere_material );
                sphere.position.x = x;
                sphere.position.y = y;
                sphere.position.z = z;
                return sphere;
            }

            var set_sphere_position = function(sphere, x, y, z)
            {
                sphere.position.x = x;
                sphere.position.y = y;
                sphere.position.z = z;
            }

            const renderer = new THREE.WebGLRenderer();
            renderer.setSize( window.innerWidth, window.innerHeight );
            document.body.appendChild( renderer.domElement );

            const camera = new THREE.PerspectiveCamera( 100, window.innerWidth / window.innerHeight, 1, 500 );

            const controls = new OrbitControls( camera, renderer.domElement );
            camera.position.set( 50, 50, 100 );
            camera.lookAt( 50, 50, 50 );
            controls.update();

            const scene = new THREE.Scene();

            var line_boundary = create_line_boundary();
            var sphere_red = create_sphere(0, 50, -50, 2, 0xff0000);
            var sphere_green = create_sphere(50, 50, -50, 2, 0x00ff00);
            var sphere_blue = create_sphere(50, 50, 0, 2, 0x0000ff);

            scene.add( line_boundary );
            scene.add( sphere_red );
            scene.add( sphere_green );
            scene.add( sphere_blue );
            renderer.render( scene, camera );

            const socket = new WebSocket('ws://localhost:8000');
            var websockConnected = false;
            function animate() 
            {
	            requestAnimationFrame( animate );
                controls.update();
                if (websockConnected == true) 
                    socket.send("Hello");
                //set_sphere_position(sphere_red, sphere_red.position.x + 1, sphere_red.position.y, sphere_red.position.z);
	            renderer.render( scene, camera );
            }

            socket.addEventListener('open', function (event) {
                websockConnected = true;
            });

            socket.addEventListener('message', function (event) {
                var rs = JSON.parse(event.data)
                var sphere_data = JSON.parse(rs['received_string']);
                console.log(sphere_data);
                if (sphere_data.id == "red")
                {
                    set_sphere_position(sphere_red, sphere_data.x, sphere_data.y, -1 * sphere_data.z);
                }
                if (sphere_data.id == "green")
                {
                    set_sphere_position(sphere_green, sphere_data.x, sphere_data.y, -1 * sphere_data.z);
                }
                if (sphere_data.id == "blue")
                {
                    set_sphere_position(sphere_blue, sphere_data.x, sphere_data.y, -1 * sphere_data.z);
                }
            });
        animate();            
        </script>
	</body>
</html>